(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{188:function(e,t,r){"use strict";r.r(t),r.d(t,"MDXContext",(function(){return u})),r.d(t,"MDXProvider",(function(){return m})),r.d(t,"mdx",(function(){return b})),r.d(t,"useMDXComponents",(function(){return p})),r.d(t,"withMDXComponents",(function(){return d}));var n=r(0),a=r.n(n);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var u=a.a.createContext({}),d=function(e){return function(t){var r=p(t.components);return a.a.createElement(e,o({},t,{components:r}))}},p=function(e){var t=a.a.useContext(u),r=t;return e&&(r="function"==typeof e?e(t):l(l({},t),e)),r},m=function(e){var t=p(e.components);return a.a.createElement(u.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},g=a.a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(r),d=n,m=u["".concat(o,".").concat(d)]||u[d]||h[d]||i;return r?a.a.createElement(m,l(l({ref:t},c),{},{components:r})):a.a.createElement(m,l({ref:t},c))}));function b(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,o=new Array(i);o[0]=g;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:n,o[1]=c;for(var s=2;s<i;s++)o[s]=r[s];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,r)}g.displayName="MDXCreateElement"},49:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return o})),r.d(t,"metadata",(function(){return c})),r.d(t,"toc",(function(){return l})),r.d(t,"default",(function(){return u}));var n=r(3),a=r(8),i=(r(0),r(188)),o={sidebar_position:3,keywords:"parachains"},c={unversionedId:"parachains/b-runtime-upgrades/upgrade-scheduler",id:"parachains/b-runtime-upgrades/upgrade-scheduler",isDocsHomePage:!1,title:"How to use the scheduler pallet for storage migrations",description:"\ud83c\udfaf",source:"@site/docs/07-parachains/b-runtime-upgrades/upgrade-scheduler.md",sourceDirName:"07-parachains/b-runtime-upgrades",slug:"/parachains/b-runtime-upgrades/upgrade-scheduler",permalink:"/substrate-how-to-guides/docs/parachains/b-runtime-upgrades/upgrade-scheduler",editUrl:"https://github.com/substrate-developer-hub/substrate-how-to-guides/edit/main/docs/07-parachains/b-runtime-upgrades/upgrade-scheduler.md",version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,keywords:"parachains"},sidebar:"tutorialSidebar",previous:{title:"Set-up your runtime and client",permalink:"/substrate-how-to-guides/docs/parachains/b-runtime-upgrades/setup-runtime-and-client"},next:{title:"How to reserve a ParaID",permalink:"/substrate-how-to-guides/docs/parachains/c-registration/register-paraID"}},l=[{value:"Goal",id:"goal",children:[]},{value:"Use cases",id:"use-cases",children:[]},{value:"Overview",id:"overview",children:[]},{value:"Steps",id:"steps",children:[{value:"1. Define extrinsics in the runtime",id:"1-define-extrinsics-in-the-runtime",children:[]},{value:"2. Add the Scheduler type to the Configuration trait.",id:"2-add-the-scheduler-type-to-the-configuration-trait",children:[]},{value:"3. Schedule the calls within  the  <code>on_runtime_upgrade</code> hook",id:"3-schedule-the-calls-within--the--on_runtime_upgrade-hook",children:[]},{value:"4. Trigger the migrations.",id:"4-trigger-the-migrations",children:[]}]},{value:"Examples",id:"examples",children:[]},{value:"Resources",id:"resources",children:[]}],s={toc:l};function u(e){var t=e.components,r=Object(a.default)(e,["components"]);return Object(i.mdx)("wrapper",Object(n.default)({},s,r,{components:t,mdxType:"MDXLayout"}),Object(i.mdx)("p",null,"\ud83c\udfaf"),Object(i.mdx)("h2",{id:"goal"},"Goal"),Object(i.mdx)("p",null,"Implement storage migration logic using Substrate\u2019s scheduler pallet for non-core migrations."),Object(i.mdx)("h2",{id:"use-cases"},"Use cases"),Object(i.mdx)("ul",null,Object(i.mdx)("li",{parentName:"ul"},"Removing old unused storage during a runtime upgrade"),Object(i.mdx)("li",{parentName:"ul"},"Migrating storage unrelated to the core logic of the chain (if the upgraded logic does not depend on the new storage format).")),Object(i.mdx)("h2",{id:"overview"},"Overview"),Object(i.mdx)("p",null,"This guide outlines steps to schedule non-core storage or other runtime migrations using the scheduler pallet."),Object(i.mdx)("h2",{id:"steps"},"Steps"),Object(i.mdx)("h3",{id:"1-define-extrinsics-in-the-runtime"},"1. Define extrinsics in the runtime"),Object(i.mdx)("p",null,"Define extrinsics that you want to be scheduled. Ensure the extrinsics can only be called via root or a pallet origin. When scheduling the extrinsics from your pallet, use this origin."),Object(i.mdx)("pre",null,Object(i.mdx)("code",{parentName:"pre",className:"language-rust"},"\n#[pallet::call]\nimpl<T: Config> Pallet<T> {\n    pub fn example_run_migration(\n        origin: OriginFor<T>\n    ) -> DispatchResult {\n        ensure_root(origin)?;\n        //This extrinsic is what you schedule in your migration code.\n        //It contains the migration logic. \n    }\n}\n\n")),Object(i.mdx)("h3",{id:"2-add-the-scheduler-type-to-the-configuration-trait"},"2. Add the Scheduler type to the Configuration trait."),Object(i.mdx)("p",null,"You need to define the Scheduler trait in your Config trait to access the Scheduler pallet from your pallet.\nTraits in the Scheduler pallet require a defined Call type as a parameter. You can also define the Call type in your Config trait to match your on-chain Scheduler pallet. "),Object(i.mdx)("pre",null,Object(i.mdx)("code",{parentName:"pre",className:"language-rust"},"#[pallet::config]\npub trait Config: frame_system::Config {\n    /// The Call type that is scheduled.\n    type ScheduledCall: Parameter + Dispatchable<Origin = Self::Origin> + From<Call<Self>>;\n    /// The Scheduler.\n    type Scheduler: ScheduleNamed<Self::BlockNumber, Self::ScheduledCall, Self::Origin>;\n}\n")),Object(i.mdx)("h3",{id:"3-schedule-the-calls-within--the--on_runtime_upgrade-hook"},"3. Schedule the calls within  the  ",Object(i.mdx)("inlineCode",{parentName:"h3"},"on_runtime_upgrade")," hook"),Object(i.mdx)("ul",null,Object(i.mdx)("li",{parentName:"ul"},"use the ",Object(i.mdx)("a",{parentName:"li",href:"https://github.com/paritytech/substrate/blob/master/frame/scheduler/src/lib.rs#L404"},Object(i.mdx)("inlineCode",{parentName:"a"},"schedule_named"))," method from the Scheduler pallet to trigger your migration extrinsic.")),Object(i.mdx)("pre",null,Object(i.mdx)("code",{parentName:"pre",className:"language-rust"},"#[pallet::hooks]\nimpl<T: Config> Hooks<BlockNumberFor<T>> for Pallet<T> {\n    fn on_runtime_upgrade() -> Weight {\n    // Anything that needs to be executed after the runtime upgrade but before on_initialize().\n        match T::Scheduler::schedule_named(\n            id,\n            DispatchTime::At(when),\n            maybe_periodic,\n            priority,\n            RawOrigin::Root.into()\n            Call::example_run_migration().into(),\n        )\n        {\n            Err(err) => frame_support::print(err),\n            _ => (),\n        };\n\n        0 // Calculate the weight of this function.\n    }\n}\n\n")),Object(i.mdx)("div",{className:"admonition admonition-tip alert alert--success"},Object(i.mdx)("div",{parentName:"div",className:"admonition-heading"},Object(i.mdx)("h5",{parentName:"div"},Object(i.mdx)("span",{parentName:"h5",className:"admonition-icon"},Object(i.mdx)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(i.mdx)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),Object(i.mdx)("div",{parentName:"div",className:"admonition-content"},Object(i.mdx)("p",{parentName:"div"}," Schedule the extrinsic  for the blocks after the migration executes. If it takes an unknown length of time to execute, set up a counter within the extrinsic to make sure that it stops once it hits a certain weight and then schedules itself again for the next block."))),Object(i.mdx)("h3",{id:"4-trigger-the-migrations"},"4. Trigger the migrations."),Object(i.mdx)("p",null,"Once you have defined the calls and the ",Object(i.mdx)("inlineCode",{parentName:"p"},"on_runtime_upgrade")," hook you can trigger the migrations by upgrading the runtime as described ",Object(i.mdx)("a",{parentName:"p",href:"https://substrate.dev/substrate-how-to-guides/docs/storage-migrations/migration-steps-polkadotjs"},"here")),Object(i.mdx)("h2",{id:"examples"},"Examples"),Object(i.mdx)("ul",null,Object(i.mdx)("li",{parentName:"ul"},"Calls scheduling in  the ",Object(i.mdx)("a",{parentName:"li",href:"https://github.com/paritytech/substrate/blob/0f934e970501136c7370a3bbd234b96c81f59cba/frame/democracy/src/lib.rs#L1711"},"democracy pallet"))),Object(i.mdx)("h2",{id:"resources"},"Resources"),Object(i.mdx)("ul",null,Object(i.mdx)("li",{parentName:"ul"},"Scheduler pallet ",Object(i.mdx)("a",{parentName:"li",href:"https://github.com/paritytech/substrate/tree/0f934e970501136c7370a3bbd234b96c81f59cba/frame/scheduler"},"implementation")),Object(i.mdx)("li",{parentName:"ul"},Object(i.mdx)("a",{parentName:"li",href:"./runtime-upgrades#2-choose-your-upgrade-approach"},"Manual storage migration"))))}u.isMDXComponent=!0}}]);